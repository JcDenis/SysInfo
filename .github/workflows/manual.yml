# This is a basic workflow that is manually triggered

name: Manual workflow

# Controls when the action will run. Workflow runs when manually triggered using the UI
# or API.
on:
  workflow_dispatch:

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:

  # This workflow contains a single job called "dcstore"
  dcstore:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:

    # Setup PHP
    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.0'

    # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
    - uses: actions/checkout@v2

    # Run PHP code
    - name: Run PHP code
      id: getversion
      shell: php {0}
      run: |
        <?php
        $df = file_get_contents('./_define.php');
        $version = '';
        $dcmin = '2.0';
        if (preg_match('/registerModule\((.*?),(.*?),(.*?),(.*?)\'(.*?)\'(.*?)(,.*)\)/s',$df,$matches)) {
          if (isset($matches[5])) {
            $version = $matches[5];
            if (isset($matches[7])) {
              $str = $matches[7];
              if (preg_match('/\[(.*?)'core'(.*?),(.*?)'(.*?)'(.*?)\]/s',$str,$submatches)) {
                $dcmin = $submatches[4];
              }
            }
          }
        }
        echo "::set-output name=module_version::$version";
        echo "::set-output name=module_dcmin::$dcmin";

    # Cope with returned version
    - name: Log output of the script
      run: echo "${{steps.getversion.outputs.module_version}} (dotclear ${{steps.getversion.outputs.module_dcmin}}+)"
